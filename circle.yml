machine:
  timezone: Asia/Tokyo
  node:
    version: 8.1.0
  python:
    version: 3.6.0
  services:
    - mysql
  environment:
    GOPATH: $HOME/$CIRCLE_PROJECT_REPONAME/go-api
    PATH: $PATH:$GOPATH/bin
    DOCUMENT_ENV: test
    GO15VENDOREXPERIMENT: 1
  post:
    - ./daemon:
      background: true
    - sleep 5

database:
  override:
    - 'mysql -u ubuntu -e "CREATE DATABASE IF NOT EXISTS circle_default DEFAULT CHARSET utf8"'
    - 'mysql -u ubuntu -e "CREATE DATABASE IF NOT EXISTS circle_test DEFAULT CHARSET utf8"'


dependencies:
  pre:
    - pip install selenium
    - git clone https://github.com/YasushiKobayashi/go-api.git
    - curl https://glide.sh/get | sh
    - cd go-api/src/document/config && mv sample.tml config.tml
    - cd go-api/src/document/config && mv env.sample env.go
    - cd go-api/src/document && glide install
    - cd go-api/src/document && go build main.go
    - cd go-api/src/document && ./main &
    - wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
    - sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
    - sudo apt-get update
    - sudo apt-get --only-upgrade install google-chrome-stable
    - npm install -g yarn mocha
    - yarn
    - npm rebuild node-sass
    - cd src && mv config.sample.js config.js

test:
  override:
    - npm run lint
    - npm run flow
    - npm run test
    - npm run build
    - npm run server
    - python selenium/test_webdriver.py
    - mv selenium/log $CIRCLE_ARTIFACTS
    - exit 0
