machine:
  timezone: Asia/Tokyo
  node:
    version: 8.1.0
  python:
    version: 3.6.0
  services:
    - mysql
  environment:
    GOPATH: $HOME/$CIRCLE_PROJECT_REPONAME/go-api
    PATH: $PATH:$GOPATH/bin
    DOCUMENT_ENV: test
    GO15VENDOREXPERIMENT: 1

database:
  override:
    - 'mysql -u ubuntu -e "CREATE DATABASE IF NOT EXISTS circle_default DEFAULT CHARSET utf8"'
    - 'mysql -u ubuntu -e "CREATE DATABASE IF NOT EXISTS circle_test DEFAULT CHARSET utf8"'


dependencies:
  cache_directories:
    - node_modules
    - go-api/src/app/vendor
  pre:
    - pip install selenium
    - git clone https://github.com/YasushiKobayashi/go-api.git
    - curl https://glide.sh/get | sh
    - cd go-api/src/app/config && mv sample.tml config.tml
    - cd go-api/src/app && glide install
    - cd go-api/src/app && go build main.gl
    - npm install -g yarn mocha
    - yarn
    - npm rebuild node-sass
    - cd src && mv config.sample.js config.js
    - wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
    - sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
    - sudo apt-get update
    - sudo apt-get --only-upgrade install google-chrome-stable

test:
  override:
    - npm run lint
    - npm run flow
    - npm run test
    - npm run build
    - npm run server
    - cd go-api/src/app && ./main &
    - npm run test:selenium
    - cp selenium/log/* $CIRCLE_ARTIFACTS
    - cp go-api/src/app/log $CIRCLE_ARTIFACTS
    - exit 0
